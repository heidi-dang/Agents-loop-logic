# Heidi CLI UI Migration Worklog
## Date: 2026-02-17
## Branch: feat/ui-work-theme (migrating to feat/ui-packaging)

### Summary
Successfully migrated Heidi CLI UI from legacy architecture to new Vite-based React application, integrated with Heidi backend API, and established production packaging/release pipeline.

### Commit Range
Base: bfd38de (Merge pull request #69 - palette-ux-improvements)
Changes: Working tree modifications (not yet committed as single squashed commit)
Estimated files changed: 36 files, +2682/-3648 lines

### Key Deliverables

1. **UI Migration (dev_1_ui_migrator)**
   - Cloned work UI repo (commit: d512c199) as visual base
   - Removed Next.js server.ts, socket.io, SSH dependencies
   - Created Vite React app structure (src/main.tsx entry)
   - Implemented Heidi API client layer:
     - src/api/heidi.ts: health(), listAgents(), listRuns(), getRun(), runOnce(), runLoop(), chat(), cancelRun()
     - src/api/stream.ts: SSE streaming with polling fallback
   - Migrated components: Sidebar, ChatArea, AgentArea, TerminalArea, SettingsModal, RightSidebar
   - Terminal tab: Safe MVP placeholder (no SSH, no socket.io)

2. **Configuration**
   - vite.config.ts: port 3002, strictPort, allowedHosts (heidiai.com.au)
   - Proxy routes to backend: /health, /agents, /run, /loop, /chat, /runs, /api
   - No direct Gemini/OpenAI keys in browser (all through Heidi backend)

3. **Packaging & Release (dev_3_packaging_release)**
   - UI builds to ui/dist (Vite standard output)
   - CLI command: `heidi ui build` (builds with --base=/ui/, copies to ~/.cache/heidi/ui/dist)
   - Backend serves SPA at /ui/ with fallback routing
   - Package data: pyproject.toml includes ui_dist/**/* in setuptools package-data
   - Dist resolution order: HEIDI_UI_DIST env -> HEIDI_HOME/ui/dist -> XDG_CACHE/heidi/ui/dist -> bundled ui_dist
   - CI guardrail: GitHub Actions job ui-build (Node 20, npm cache, verifies dist artifacts)
   - Git policy: src/heidi_cli/ui_dist/ ignored (line 80 in .gitignore)

4. **Documentation**
   - README.md: Added Web UI section with dev/prod instructions
   - Port reference table: 3002 (Vite dev), 7777 (backend)
   - CORS/allowedHosts documentation for custom domains

### Verification Steps Completed
1. ✓ UI builds: npm ci && npm run build → ui/dist/index.html + assets/
2. ✓ CLI build: heidi ui build --force → ~/.cache/heidi/ui/dist/
3. ✓ Backend serve: HEIDI_UI_DIST=... heidi serve → /ui/ accessible
4. ✓ Package install: pip install -e '.[dev]' → heidi ui --help works
5. ✓ CI job: .github/workflows/ci.yml includes ui-build job
6. ✓ Git ignore: src/heidi_cli/ui_dist/ properly excluded

### Notes
- UI assets are built during packaging and included in wheel/sdist
- Source UI in ui/ remains in git (source code)
- Built UI in src/heidi_cli/ui_dist/ is git-ignored but setuptools-included
- Default behavior: heidi serve falls back to bundled ui_dist if no cache built

### Breaking Changes
None - this is additive. Legacy CLI commands remain functional.

### Testing Required Before Merge
1. Clean install smoke test (container/fresh venv)
2. Verify no 404s on asset paths with correct base=/ui/
3. Confirm SPA routing works (refresh on /ui/ doesn't 404)
